<!-- tracker/templates/tracker/entry_list.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Diet Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .calories-table, .chart-container {
            margin-top: 20px;
        }
        .chart-container {
            max-width: 600px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Journal d'activités</h1>
        
        <div class="mb-3">
            <a href="{% url 'add_entry' %}" class="btn btn-success me-2">Ajouter une entrée</a>
            <a href="{% url 'export_csv' %}" class="btn btn-info">Exporter en CSV</a>
            <a href="{% url 'import_csv' %}" class="btn btn-primary">Importer un CSV</a>
        </div>
        
        <form class="mb-3" method="get">
            <div class="row g-2 align-items-center">
                <div class="col-auto">
                    <label for="period" class="form-label">Filtrer par période :</label>
                </div>
                <div class="col-auto">
                    <select name="period" id="period" class="form-select" onchange="this.form.submit()">
                        <option value="">Toutes</option>
                        {% for period in periods %}
                            <option value="{{ period }}" {% if period == selected_period %}selected{% endif %}>
                                {{ period|cut:"01 "|cut:"02 "|cut:"03 "|cut:"04 "|cut:"05 "|cut:"06 "|cut:"07 " }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
        
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Heure</th>
                    <th>Période</th>
                    <th>Activité</th>
                    <th>Description</th>
                    <th>Calories (kcal)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in page_obj %}
                    <tr>
                        <td>{{ entry.date }}</td>
                        <td>{{ entry.time }}</td>
                        <td>{{ entry.get_period_display }}</td>
                        <td>{{ entry.get_activity_display }}</td>
                        <td>{{ entry.data }}</td>
                        <td>{{ entry.kcal|default:"-" }}</td>
                        <td>
                            <a href="{% url 'edit_entry' entry.id %}" class="btn btn-primary btn-sm">Modifier</a>
                            <a href="{% url 'delete_entry' entry.id %}" class="btn btn-danger btn-sm">Supprimer</a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7">Aucune entrée trouvée.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if selected_period %}&period={{ selected_period }}{% endif %}">« Première</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if selected_period %}&period={{ selected_period }}{% endif %}">Précédente</a>
                    </li>
                {% endif %}
                <li class="page-item disabled">
                    <span class="page-link">Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}</span>
                </li>
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if selected_period %}&period={{ selected_period }}{% endif %}">Suivante</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if selected_period %}&period={{ selected_period }}{% endif %}">Dernière »</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        
        <div class="row">
            <div class="col-md-6">
                <h2 class="mt-4">Calories consommées (nourriture)</h2>
                <table class="table table-striped calories-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total Calories (kcal)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in daily_calories_consumed %}
                            <tr>
                                <td>{{ day.date }}</td>
                                <td>{{ day.total_kcal }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="2">Aucune donnée calorique disponible.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h2 class="mt-4">Calories brûlées (activités physiques)</h2>
                <table class="table table-striped calories-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total Calories (kcal)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in daily_calories_burned %}
                            <tr>
                                <td>{{ day.date }}</td>
                                <td>{{ day.total_kcal }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="2">Aucune donnée calorique disponible.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 chart-container">
                <h2 class="mt-4">Graphique des calories consommées</h2>
                <canvas id="consumedChart"></canvas>
            </div>
            <div class="col-md-6 chart-container">
                <h2 class="mt-4">Graphique des calories brûlées</h2>
                <canvas id="burnedChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Données JSON pour Chart.js -->
    {{ daily_calories_consumed|json_script:"consumed-dates" }}
    {{ daily_calories_burned|json_script:"burned-dates" }}
    <!-- Script Chart.js -->
    <script type="text/javascript">
        // Récupérer les données JSON
        const consumedDataParsed = JSON.parse(document.getElementById('consumed-dates').textContent);
        const consumedLabels = consumedDataParsed.map(day => day.date);
        const consumedData = consumedDataParsed.map(day => day.total_kcal);

        const burnedDataParsed = JSON.parse(document.getElementById('burned-dates').textContent);
        const burnedLabels = burnedDataParsed.map(day => day.date);
        const burnedData = burnedDataParsed.map(day => day.total_kcal);

        // Graphique des calories consommées
        const consumedCtx = document.getElementById('consumedChart').getContext('2d');
        new Chart(consumedCtx, {
            type: 'line',
            data: {
                labels: consumedLabels,
                datasets: [{
                    label: 'Calories consommées (kcal)',
                    data: consumedData,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Graphique des calories brûlées
        const burnedCtx = document.getElementById('burnedChart').getContext('2d');
        new Chart(burnedCtx, {
            type: 'line',
            data: {
                labels: burnedLabels,
                datasets: [{
                    label: 'Calories brûlées (kcal)',
                    data: burnedData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: true,
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
</body>
</html>